<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết sản phẩm</title>
    <link rel="stylesheet" href="/css/chi-tiet-san-pham.css">
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/Shopthoitrang/css/chi-tiet-san-pham.css">
</head>
<body>
    <header>
        <h1>DTN Shop</h1>
        <nav>
            <a href="/Shopthoitrang/trang-chu.html">Trang chủ</a> |
            <a href="/Shopthoitrang/gio-hang.html">Giỏ hàng</a> |
            <a href="/Shopthoitrang/lich-su-don-hang.html">Lịch sử đơn hàng</a>
        </nav>
    </header>
    <main>
        <div id="chi-tiet-san-pham" class="container-chi-tiet"></div>
    </main>
    <div id="toast" style="position:fixed;bottom:30px;right:30px;z-index:999;display:none;min-width:200px;background:#d76d77;color:#fff;padding:14px 24px;border-radius:8px;box-shadow:0 4px 18px #d76d77c0;font-weight:600;"></div>
    <script>
        function getIdSanPham() {
            const params = new URLSearchParams(window.location.search);
            return parseInt(params.get('id'), 10);
        }

        function dinhDangGia(gia) {
            return gia.toLocaleString('vi-VN') + '₫';
        }

        async function getSanPham(idSanPham) {
            try {
                const response = await fetch(`http://127.0.0.1:5000/sanpham/${idSanPham}`);
                if (!response.ok) throw new Error('Lỗi khi lấy thông tin sản phẩm');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Lỗi API getSanPham:', error);
                return null;
            }
        }

        async function hienThiChiTietSanPham() {
            const id = getIdSanPham();
            const container = document.getElementById('chi-tiet-san-pham');
            const sp = await getSanPham(id);
            if (!sp) {
                container.innerHTML = `<div style="padding:32px;text-align:center;color:#d76d77;font-weight:bold;">Không tìm thấy sản phẩm!</div>`;
                return;
            }
            container.innerHTML = `
                <div class="ctsp-anh">
                    <img src="${sp.hinh_anh}" alt="${sp.ten_san_pham}">
                </div>
                <div class="ctsp-thong-tin">
                    <h2>${sp.ten_san_pham}</h2>
                    <div class="ctsp-gia">${dinhDangGia(sp.gia)}</div>
                    <div class="ctsp-mo-ta">${sp.mo_ta || "Chưa có mô tả chi tiết cho sản phẩm này."}</div>
                    <div class="ctsp-btn">
                        <button onclick="themVaoGio(${sp.id_san_pham})">Thêm vào giỏ</button>
                        <button onclick="window.history.back()">Quay lại</button>
                    </div>
                </div>
            `;
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.display = 'block';
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.transition = 'opacity 0.4s';
                toast.style.opacity = '0';
            }, 1400);
            setTimeout(() => {
                toast.style.display = 'none';
                toast.style.transition = '';
            }, 1900);
        }

        async function themVaoGio(idSanPham) {
            // Giả định ID khách hàng (trong thực tế, lấy từ phiên đăng nhập hoặc localStorage)
            const idKhachHang = 1;
            try {
                const response = await fetch('http://127.0.0.1:5000/giohang', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id_khach_hang: idKhachHang,
                        id_san_pham: idSanPham,
                        so_luong: 1
                    })
                });
                if (response.ok) {
                    showToast('Đã thêm sản phẩm vào giỏ!');
                } else {
                    const errorData = await response.json();
                    showToast('Lỗi: ' + errorData.error);
                }
            } catch (error) {
                console.error('Lỗi API themVaoGio:', error);
                showToast('Lỗi khi thêm vào giỏ hàng!');
            }
        }

        window.onload = hienThiChiTietSanPham;
    </script>
</body>
</html>